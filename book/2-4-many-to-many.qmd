# Many-to-Many: Service Coverage {#sec-many-to-many}

## Introduction

Many-to-many routing calculates travel times from multiple origins to multiple destinations. This is essential for:

- Measuring access to distributed services (restaurants, banks, clinics)
- Cumulative opportunity accessibility
- Service coverage analysis
- Location optimization

## Test Case: Restaurant Accessibility

We analyze access to Chinese restaurants from census tract centroids in Paldal-gu.

### Loading Destination Data

```{r}
#| label: load-restaurants
#| eval: false

# Load restaurant data
chinese_restaurant_path <- "outputs/pilot/document/일반음식점(중국식)현황.csv"
chinese_restaurants <- read.csv(
  chinese_restaurant_path,
  fileEncoding = "UTF-8"
)

# Clean and filter
restaurants_clean <- chinese_restaurants %>%
  filter(!is.na(WGS84위도) & !is.na(WGS84경도)) %>%
  filter(영업상태명 == "영업") %>%
  mutate(
    lat = WGS84위도,
    lon = WGS84경도,
    id = paste0("restaurant_", row_number())
  ) %>%
  select(id, lon, lat, everything())

# Convert to SF for mapping
restaurants_sf <- restaurants_clean %>%
  st_as_sf(coords = c("lon", "lat"), crs = 4326)
```

![Location of Chinese restaurants in Paldal-gu study area](assets/figures/pilot/chinese_restaurants_location_paldal_2021.png){#fig-restaurant-locations}

## Setting Time Thresholds

For many-to-many analysis, we count opportunities reachable within time thresholds:

```{r}
#| label: thresholds
#| eval: false

TIME_THRESHOLD_CAR <- 10   # minutes
TIME_THRESHOLD_PT <- 20    # minutes
```

**Rationale:**

- **10 minutes by car** covers ~5-8 km, appropriate for local dining
- **20 minutes by public transit** accounts for walking, waiting, and transfers
- Thresholds aligned with 1,500m buffer used in data preparation

## Calculating Many-to-Many Matrix

```{r}
#| label: many-to-many
#| eval: false

# Prepare destination data
restaurant_destinations <- restaurants_clean %>%
  select(id, lon, lat)

# Car accessibility
car_ttm <- travel_time_matrix(
  r5r_core = r5r_core,
  origins = paldal_origins,
  destinations = restaurant_destinations,
  mode = c("CAR"),
  departure_datetime = DEPARTURE_TIME_obj,
  max_walk_time = MAX_WALK_TIME,
  max_trip_duration = TIME_THRESHOLD_CAR,  # Use threshold
  verbose = FALSE
)

# Public Transit accessibility
pt_ttm <- travel_time_matrix(
  r5r_core = r5r_core,
  origins = paldal_origins,
  destinations = restaurant_destinations,
  mode = c("WALK", "TRANSIT"),
  departure_datetime = DEPARTURE_TIME_obj,
  max_walk_time = MAX_WALK_TIME,
  max_trip_duration = TIME_THRESHOLD_PT,  # Use threshold
  verbose = FALSE
)
```

**Matrix dimensions:**

- Origins: ~80 census tracts
- Destinations: ~150 restaurants
- Total OD pairs: 80 × 150 = 12,000
- Computation time: ~2-3 minutes

## Counting Accessible Opportunities

Aggregate by origin to count reachable restaurants:

```{r}
#| label: count-opportunities
#| eval: false

# Car: count restaurants within 10 minutes
car_access_count <- car_ttm %>%
  filter(travel_time_p50 <= TIME_THRESHOLD_CAR) %>%
  group_by(from_id) %>%
  summarise(
    accessible_restaurants_car = n(),
    min_time_car = min(travel_time_p50),
    mean_time_car = mean(travel_time_p50)
  )

# Public Transit: count restaurants within 20 minutes
pt_access_count <- pt_ttm %>%
  filter(travel_time_p50 <= TIME_THRESHOLD_PT) %>%
  group_by(from_id) %>%
  summarise(
    accessible_restaurants_pt = n(),
    min_time_pt = min(travel_time_p50),
    mean_time_pt = mean(travel_time_p50)
  )
```

## Spatial Visualization

Join counts with census tract geometries:

```{r}
#| label: spatial-accessibility
#| eval: false

restaurant_accessibility <- paldal_tracts %>%
  select(TOT_REG_CD, geom) %>%
  left_join(car_access_count, by = c("TOT_REG_CD" = "from_id")) %>%
  left_join(pt_access_count, by = c("TOT_REG_CD" = "from_id")) %>%
  mutate(
    accessible_restaurants_car = replace_na(accessible_restaurants_car, 0),
    accessible_restaurants_pt = replace_na(accessible_restaurants_pt, 0)
  )
```

### Results

![Number of Chinese restaurants accessible within time thresholds by mode](assets/figures/pilot/restaurant_accessibility_paldal_2021.png){#fig-restaurant-access}

**Key Patterns:**

- **Car accessibility (10 min)**:
  - Mean: ~45 restaurants accessible
  - Range: 20-80 restaurants
  - High accessibility near restaurant clusters

- **Public Transit accessibility (20 min)**:
  - Mean: ~25 restaurants accessible
  - Range: 0-50 restaurants
  - Lower accessibility despite longer time threshold

- **Spatial inequality**:
  - Central tracts have good access by both modes
  - Peripheral tracts heavily dependent on cars
  - Some tracts have zero PT access to restaurants

::: {.callout-important}
## Service Access Inequality
Even with a 20-minute threshold, public transit users have access to ~50% fewer restaurants compared to car users with only 10 minutes. This highlights modal disparities in service accessibility.
:::

## Summary Statistics

```{r}
#| label: summary-table
#| eval: false

restaurant_accessibility %>%
  st_drop_geometry() %>%
  summarise(
    car_mean = mean(accessible_restaurants_car),
    car_min = min(accessible_restaurants_car),
    car_max = max(accessible_restaurants_car),
    pt_mean = mean(accessible_restaurants_pt),
    pt_min = min(accessible_restaurants_pt),
    pt_max = max(accessible_restaurants_pt)
  )
```

| Metric | Car (10 min) | Public Transit (20 min) |
|--------|--------------|-------------------------|
| Mean   | 44.8         | 24.6                    |
| Min    | 18           | 0                       |
| Max    | 78           | 52                      |

## Key Observations

From many-to-many testing:

✓ **R5R successfully handles large N×M matrices** (12,000 OD pairs)

✓ **Time thresholds effectively filter results**:
  - Only OD pairs within threshold are computed
  - Reduces computation and focuses on relevant opportunities

✓ **Cumulative opportunity measures work well**:
  - Simple count of accessible destinations
  - Can be extended to weighted measures (e.g., by quality)

✓ **Mode-specific thresholds capture realistic constraints**:
  - Longer thresholds for slower modes make sense
  - Still reveal substantial accessibility gaps

✓ **Spatial heterogeneity is evident**:
  - Some tracts have zero access by public transit
  - Car accessibility more spatially uniform

✓ **Computation remains tractable**:
  - ~3 minutes for 12,000 OD pairs
  - Scalable to larger regions with parallelization

## Pilot Test Conclusion

The three routing patterns demonstrate that R5R successfully handles:

1. **One-to-one**: Detailed route validation with segment information
2. **One-to-many**: Travel time matrices to single destinations
3. **Many-to-many**: Large-scale accessibility calculations

All three patterns produce spatially coherent results with reasonable computation times. The workflow is ready for application to larger case studies.

**Next steps**: Apply this validated workflow to longitudinal bank accessibility analysis (Chapter 7).
