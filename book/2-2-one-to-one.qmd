# One-to-One: Route Validation {#sec-one-to-one}

## Introduction

One-to-one routing generates detailed itineraries between individual origin-destination pairs. This is useful for:

- Understanding routing behavior
- Validating parameter settings
- Visualizing multimodal journey segments
- Debugging unexpected results

## Defining Test Cases

We define three representative OD pairs in Paldal-gu:

```{r}
#| label: od-pairs
#| eval: false

library(dplyr)

od_pairs <- tribble(
  ~origin_id,       ~origin_lon, ~origin_lat, ~dest_id,        ~dest_lon, ~dest_lat,  ~origin_name,             ~dest_name,
  "CentralLibrary", 127.01216,   37.27325,    "SuwonCityHall", 127.02866, 37.26351,   "Suwon Central Library",  "Suwon City Hall",
  "PaldalOffice",   127.02011,   37.28254,    "SuwonCityHall", 127.02866, 37.26351,   "Paldal District Office", "Suwon City Hall",
  "SuwonStation",   127.00085,   37.26639,    "SuwonCityHall", 127.02866, 37.26351,   "Suwon Station",          "Suwon City Hall"
) %>%
  mutate(name = paste(origin_id, dest_id, sep = "_to_"))
```

## Routing Function

We create a function to handle mode-specific routing:

```{r}
#| label: routing-function
#| eval: false

get_route <- function(origin_df, dest_df, travel_mode, mode_name, pair_name) {
  mode_config <- list(
    "PT" = c("WALK", "TRANSIT"),
    "CAR" = c("CAR"),
    "WALK" = c("WALK")
  )

  # WALK mode requires special settings
  if (travel_mode == "WALK") {
    route <- detailed_itineraries(
      r5r_network = r5r_core,
      origins = origin_df,
      destinations = dest_df,
      mode = c("WALK"),
      departure_datetime = DEPARTURE_TIME_obj,
      max_walk_time = 120,      # Extended for walk-only
      max_trip_duration = 120,
      shortest_path = FALSE,    # Important: FALSE for WALK
      verbose = TRUE
    )
  } else {
    route <- detailed_itineraries(
      r5r_network = r5r_core,
      origins = origin_df,
      destinations = dest_df,
      mode = mode_config[[travel_mode]],
      departure_datetime = DEPARTURE_TIME_obj,
      max_walk_time = MAX_WALK_TIME,
      max_trip_duration = MAX_TRIP_DURATION,
      shortest_path = TRUE,
      verbose = FALSE
    )
  }

  return(route)
}
```

::: {.callout-important}
## Walk Mode Requirements
Walk-only routing requires `shortest_path = FALSE` to avoid routing engine errors. This is a known R5R behavior.
:::

## Calculating Routes

We calculate routes for all OD pairs and travel modes:

```{r}
#| label: calculate-routes
#| eval: false

# Calculate all combinations
route_list <- od_pairs %>%
  crossing(tibble(
    travel_mode = c("PT", "CAR", "WALK"),
    mode_name = c("Public Transit", "Car", "Walk Only")
  )) %>%
  mutate(
    routes = pmap(
      list(origin_id, origin_lon, origin_lat,
           dest_id, dest_lon, dest_lat,
           travel_mode, mode_name, name),
      function(oid, olon, olat, did, dlon, dlat, tmode, mname, pname) {
        origin_df <- data.frame(id = oid, lon = olon, lat = olat)
        dest_df <- data.frame(id = did, lon = dlon, lat = dlat)
        get_route(origin_df, dest_df, tmode, mname, pname)
      }
    )
  ) %>%
  pull(routes)

# Combine all routes
all_routes_sf <- route_list %>%
  discard(is.null) %>%
  bind_rows()
```

## Results: Three Cases

### Case 1: Central Library to City Hall

![Case 1 shows straightforward routing across all modes. Public Transit involves two bus transfers.](assets/figures/pilot/validation_routes_case1_paldal_2021.png){#fig-case1}

**Observations:**

- Car: 8.4 minutes via direct road route
- Public Transit: 18.3 minutes with two bus segments
- Walk: 25.1 minutes via pedestrian network

### Case 2: Paldal Office to City Hall

![Case 2 demonstrates circuitous public transit routing due to shortest_path=TRUE parameter](assets/figures/pilot/validation_routes_case2_paldal_2021.png){#fig-case2}

**Observations:**

- Public Transit route appears circuitous
- This is caused by `shortest_path = TRUE` optimizing for **distance** rather than time
- Algorithm minimizes cumulative distance across all segments (walk + bus)
- Trade-off between distance-optimal and time-optimal routing

::: {.callout-note}
## Shortest Path Behavior
The `shortest_path = TRUE` parameter minimizes total distance traveled, which can result in longer travel times. For time-based accessibility analysis, consider using `shortest_path = FALSE` and selecting the fastest route among alternatives.
:::

### Case 3: Suwon Station to City Hall

![Case 3 shows subway (metro) routing between major transit nodes](assets/figures/pilot/validation_routes_case3_paldal_2021.png){#fig-case3}

**Observations:**

- Public Transit uses subway (metro line)
- Direct connection between two major stations
- Shortest travel time among three cases

## Journey Timeline Visualization

Segment-level timelines help understand multimodal journey composition:

![Timeline breakdown for Case 1 showing time spent in each mode segment](assets/figures/pilot/timeline_case1_paldal_2021.png){#fig-timeline}

**Insights from timeline:**

- Walk segments at beginning/end of PT journeys
- Bus segments show route numbers and durations
- Car mode has no intermediate segments
- Total duration varies significantly by mode

## Key Observations

From one-to-one routing tests, we learned:

✓ **R5R generates detailed routes successfully** for all three modes

✓ **Public transit routing includes realistic transfers** with walking connections

✓ **Parameter impacts are significant**:
  - `shortest_path = TRUE` can yield circuitous routes
  - `max_walk_time` affects access to transit stops
  - Mode-specific settings are necessary (especially for WALK)

✓ **Output includes rich segment information**:
  - Mode, distance, duration per segment
  - Route IDs for transit
  - Geometry for mapping

✓ **Results are spatially coherent** with expected travel patterns

These validation results confirm that R5R performs one-to-one routing reliably. We now proceed to test one-to-many patterns.
